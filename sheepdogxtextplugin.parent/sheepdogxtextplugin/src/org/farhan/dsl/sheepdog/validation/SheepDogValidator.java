/*
 * generated by Xtext 2.36.0
 */
package org.farhan.dsl.sheepdog.validation;

import java.io.PrintWriter;
import java.io.StringWriter;
import org.apache.log4j.Logger;
import org.eclipse.xtext.validation.Check;
import org.eclipse.xtext.validation.CheckType;
import org.farhan.dsl.sheepdog.sheepDog.TestStepContainer;
import org.farhan.dsl.sheepdog.impl.SourceFileRepository;
import org.farhan.dsl.sheepdog.impl.TestProjectImpl;
import org.farhan.dsl.sheepdog.impl.TestStepImpl;
import org.farhan.dsl.sheepdog.sheepDog.Cell;
import org.farhan.dsl.sheepdog.sheepDog.SheepDogPackage;
import org.farhan.dsl.sheepdog.sheepDog.TestSuite;
import org.farhan.dsl.sheepdog.sheepDog.TestStep;
import org.farhan.dsl.sheepdog.sheepDog.Table;
import org.farhan.dsl.lang.*;

/**
 * This class contains custom validation rules.
 *
 * See
 * https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#validation
 */
public class SheepDogValidator extends AbstractSheepDogValidator {

	private static final Logger logger = Logger.getLogger(SheepDogValidator.class);
	// TODO move these to sheep-dog-test and update quickfix provider
	public static final String TEST_STEP_NAME = "invalidStepName";
	public static final String TABLE_CELL_NAME = "invalidCellName";
	public static final String TEST_STEP_REFERENCE = "referenceNotFound";

	@Check(CheckType.EXPENSIVE)
	public void checkTestSuite(TestSuite feature) {
		// TODO validate that feature file name and feature name are the same.
		if (!Character.isUpperCase(feature.getName().charAt(0))) {
			warning("TestSuite name should start with a capital", SheepDogPackage.Literals.MODEL__NAME,
					TEST_STEP_NAME);
		}
	}

	@Check(CheckType.NORMAL)
	public void checkTestStepContainer(TestStepContainer abstractScenario) {
		if (!Character.isUpperCase(abstractScenario.getName().charAt(0))) {
			warning("Scenario name should start with a capital", SheepDogPackage.Literals.TEST_STEP_CONTAINER__NAME,
					TEST_STEP_NAME);
		}
	}

	@Check(CheckType.FAST)
	public void checkTestStepName(TestStep step) {
		// TODO split into 2 checks, one for name syntax and one for reference
		// and rename to checkTestStepNameInvalid and checkTestStepRefNotFound
		try {
			if (step.getName() != null) {
				ITestStep iTestStep = new TestStepImpl(step);
				String problems = TestStepIssueDetector.validateName(iTestStep);
				if (!problems.isEmpty()) {
					// TODO pass in the enum returned by validateSyntax instead of string
					error(problems, SheepDogPackage.Literals.TEST_STEP__NAME, TEST_STEP_NAME);
				} else {

					ITestProject testProject = new TestProjectImpl(
							new SourceFileRepository(step.eResource().getURI().toPlatformString(true)));
					iTestStep.getParent().getParent().setParent(testProject);
					problems = TestStepIssueDetector.validateReference(iTestStep, testProject);
					if (!problems.isEmpty()) {

						// TODO I don't need to pass in any issue data at all, the validator shouldn't
						// suggest proposals. 
						// TODO return String list instead of object array
						Object[] alternateProposals = TestStepIssueResolver.proposeStepObject(iTestStep, testProject);
						String[] alternates = new String[alternateProposals.length];
						for (int i = 0; i < alternates.length; i++) {
							alternates[i] = alternateProposals[i].toString();
						}

						// TODO pass in the enum returned by validateSyntax instead of string
						warning(problems, SheepDogPackage.Literals.TEST_STEP__NAME, TEST_STEP_REFERENCE, alternates);
					}
				}
			}
		} catch (Exception e) {
			logError(e, step.getName());
		}
	}

	@Check(CheckType.FAST)
	public void checkTableCellName(Table stepTable) {
		// TODO Add table column row validation, each row should have the max number of
		// columns
		// TODO make tests for this
		if (stepTable.getRowList() != null) {
			if (stepTable.getRowList().size() > 0) {
				for (Cell header : stepTable.getRowList().get(0).getCellList()) {
					if (!Character.isUpperCase(header.getName().charAt(0))) {
						warning("Table header names should start with a capital: " + header.getName(),
								SheepDogPackage.Literals.TABLE__ROW_LIST, TABLE_CELL_NAME, header.getName());
					}
				}
			}
		}
	}

	private void logError(Exception e, String name) {
		logger.error("There was a problem for step: " + name);
		StringWriter sw = new StringWriter();
		e.printStackTrace(new PrintWriter(sw));
		logger.error(sw.toString());
	}
}
