/*
 * generated by Xtext 2.36.0
 */
package org.farhan.dsl.sheepdog.validation;

import java.io.PrintWriter;
import java.io.StringWriter;

import org.apache.log4j.Logger;
import org.eclipse.xtext.validation.Check;
import org.eclipse.xtext.validation.CheckType;
import org.farhan.dsl.sheepdog.sheepDog.TestStepContainer;
import org.farhan.dsl.sheepdog.impl.CellImpl;
import org.farhan.dsl.sheepdog.impl.RowImpl;
import org.farhan.dsl.sheepdog.impl.SourceFileRepository;
import org.farhan.dsl.sheepdog.impl.TableImpl;
import org.farhan.dsl.sheepdog.impl.TestProjectImpl;
import org.farhan.dsl.sheepdog.impl.TestStepContainerImpl;
import org.farhan.dsl.sheepdog.impl.TestStepImpl;
import org.farhan.dsl.sheepdog.impl.TestSuiteImpl;
import org.farhan.dsl.sheepdog.impl.TextImpl;
import org.farhan.dsl.sheepdog.sheepDog.Cell;
import org.farhan.dsl.sheepdog.sheepDog.Row;
import org.farhan.dsl.sheepdog.sheepDog.SheepDogPackage;
import org.farhan.dsl.sheepdog.sheepDog.TestSuite;
import org.farhan.dsl.sheepdog.sheepDog.TestStep;
import org.farhan.dsl.sheepdog.sheepDog.Table;
import org.farhan.dsl.sheepdog.sheepDog.Text;
import org.farhan.dsl.issues.*;
import org.farhan.dsl.lang.*;

/**
 * This class contains custom validation rules.
 *
 * See
 * https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#validation
 */
public class SheepDogValidator extends AbstractSheepDogValidator {

	private static final Logger logger = Logger.getLogger(SheepDogValidator.class);
	public static final String CELL_NAME_ONLY = "CELL_NAME_ONLY";
	public static final String TEST_STEP_CONTAINER_NAME_ONLY = "TEST_STEP_CONTAINER_NAME_ONLY";
	public static final String TEST_SUITE_NAME_ONLY = "TEST_SUITE_NAME_ONLY";
	public static final String TEST_STEP_NAME_WORKSPACE = "TEST_STEP_NAME_WORKSPACE";
	public static final String TEST_STEP_NAME_COMPONENT_WORKSPACE = "TEST_STEP_NAME_COMPONENT_WORKSPACE";
	public static final String TEST_STEP_NAME_STEP_OBJECT_WORKSPACE = "TEST_STEP_NAME_STEP_OBJECT_WORKSPACE";
	public static final String TEST_STEP_NAME_STEP_DEFINITION_WORKSPACE = "TEST_STEP_NAME_STEP_DEFINITION_WORKSPACE";
	public static final String ROW_CELL_LIST_WORKSPACE = "ROW_CELL_LIST_WORKSPACE";
	public static final String TEST_STEP_NAME_ONLY = "TEST_STEP_NAME_ONLY";
	public static final String TEST_STEP_NAME_COMPONENT_ONLY = "TEST_STEP_NAME_COMPONENT_ONLY";
	public static final String TEST_STEP_NAME_DETAILS_ONLY = "TEST_STEP_NAME_DETAILS_ONLY";
	public static final String TEST_STEP_NAME_OBJECT_ONLY = "TEST_STEP_NAME_OBJECT_ONLY";
	public static final String TEST_STEP_NAME_STATE_ONLY = "TEST_STEP_NAME_STATE_ONLY";
	public static final String TEST_STEP_NAME_TIME_ONLY = "TEST_STEP_NAME_TIME_ONLY";
	public static final String TEXT_NAME_WORKSPACE = "TEXT_NAME_WORKSPACE";

	@Check(CheckType.FAST)
	public void checkTestSuiteNameOnly(TestSuite theTestSuite) {
		// TODO validate that feature file name and feature name are the same.
		ITestSuite iTestSuite = new TestSuiteImpl(theTestSuite);
		String problems = TestSuiteIssueDetector.validateNameOnly(iTestSuite);
		if (!problems.isEmpty()) {
			warning(problems, SheepDogPackage.Literals.MODEL__NAME, TEST_SUITE_NAME_ONLY);
		}
	}

	@Check(CheckType.FAST)
	public void checkTestStepContainerNameOnly(TestStepContainer theTestStepContainer) {
		try {
			ITestStepContainer iTestStepContainer = new TestStepContainerImpl(theTestStepContainer);
			String problems = TestStepContainerIssueDetector.validateNameOnly(iTestStepContainer);
			if (!problems.isEmpty()) {
				warning(problems, SheepDogPackage.Literals.TEST_STEP_CONTAINER__NAME, TEST_STEP_CONTAINER_NAME_ONLY);
			}
		} catch (Exception e) {
			logError(e, theTestStepContainer.getName());
		}
	}

	@Check(CheckType.FAST)
	public void checkTestStepNameOnly(TestStep step) {
		try {
			if (step.getName() != null) {
				ITestStep iTestStep = new TestStepImpl(step);
				// TODO this is doing ONLY and WORKSPACE checks. It's checking the workspace for
				// suggestions. That should be the responsibility of checkTestStepNameWorkspace;
				// ie to find alternates, this should just check the grammar
				String problems = TestStepIssueDetector.validateNameOnly(iTestStep);
				if (!problems.isEmpty()) {
					error(problems, SheepDogPackage.Literals.TEST_STEP__NAME, TEST_STEP_NAME_ONLY);
				}
			}
		} catch (Exception e) {
			logError(e, step.getName());
		}
	}

	// @Check(CheckType.EXPENSIVE)
	public void checkTestStepNameWorkspace(TestStep step) {
		try {
			if (step.getName() != null) {
				ITestStep iTestStep = new TestStepImpl(step);
				String problems = TestStepIssueDetector.validateNameOnly(iTestStep);
				if (problems.isEmpty()) {
					iTestStep.getParent().getParent().setParent(new TestProjectImpl(
							new SourceFileRepository(step.eResource().getURI().toPlatformString(true))));
					problems = TestStepIssueDetector.validateNameWorkspace(iTestStep);
					if (!problems.isEmpty()) {
						warning(problems, SheepDogPackage.Literals.TEST_STEP__NAME, TEST_STEP_NAME_WORKSPACE);
					}
				}
			}
		} catch (Exception e) {
			logError(e, step.getName());
		}
	}

	// @Check(CheckType.EXPENSIVE)
	public void checkRowCellListWorkspace(Row row) {
		try {
			if (row != null && row.eContainer() != null) {
				Table table = (Table) row.eContainer();
				if (table.eContainer() instanceof TestStep) {
					if (!table.getRowList().isEmpty() && table.getRowList().getFirst() == row) {
						RowImpl rowImpl = new RowImpl(row);
						String problems = RowIssueDetector.validateCellListWorkspace(rowImpl);
						if (!problems.isEmpty()) {
							warning(problems, SheepDogPackage.Literals.ROW__CELL_LIST, ROW_CELL_LIST_WORKSPACE);
						}
					}
				}
			}
		} catch (Exception e) {
			logError(e, "Row validation");
		}
	}

	@Check(CheckType.FAST)
	public void checkCellNameOnly(Cell cell) {
		// TODO validate that each row should have the max number of columns
		// TODO make tests for this
		if (cell != null) {
			ICell iCell = new CellImpl(cell);
			IRow iRow = new RowImpl((Row) cell.eContainer());
			iCell.setParent(iRow);
			ITable iTable = new TableImpl((Table) cell.eContainer().eContainer());
			iRow.setParent(iTable);
			String problems = CellIssueDetector.validateNameOnly(iCell);
			if (!problems.isEmpty()) {
				warning(problems, SheepDogPackage.Literals.CELL__NAME, CELL_NAME_ONLY);
			}
		}
	}

	@Check(CheckType.EXPENSIVE)
	public void checkTextNameWorkspace(Text text) {
		if (text != null) {
			IText iText = new TextImpl(text);
			iText.getParent().getParent().getParent().setParent(
					new TestProjectImpl(new SourceFileRepository(text.eResource().getURI().toPlatformString(true))));
			String problems = TextIssueDetector.validateNameWorkspace(iText);
			if (!problems.isEmpty()) {
				warning(problems, SheepDogPackage.Literals.TEXT__NAME, TEXT_NAME_WORKSPACE);
			}
		}
	}

	private void logError(Exception e, String name) {
		logger.error("There was a problem for step: " + name);
		StringWriter sw = new StringWriter();
		e.printStackTrace(new PrintWriter(sw));
		logger.error(sw.toString());
	}
}
