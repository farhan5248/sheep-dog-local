/*
 * generated by Xtext 2.36.0
 */
package org.farhan.dsl.sheepdog.validation;

import java.io.File;
import java.io.PrintWriter;
import java.io.StringWriter;

import org.apache.log4j.Logger;
import org.eclipse.core.resources.IFile;
import org.eclipse.core.resources.ResourcesPlugin;
import org.eclipse.core.runtime.Path;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.xtext.validation.Check;
import org.eclipse.xtext.validation.CheckType;
import org.farhan.dsl.sheepdog.sheepDog.TestStepContainer;
import org.farhan.dsl.sheepdog.impl.CellImpl;
import org.farhan.dsl.sheepdog.impl.RowImpl;
import org.farhan.dsl.sheepdog.impl.TestStepContainerImpl;
import org.farhan.dsl.sheepdog.impl.TestStepImpl;
import org.farhan.dsl.sheepdog.impl.TestSuiteImpl;
import org.farhan.dsl.sheepdog.impl.TextImpl;
import org.farhan.dsl.sheepdog.sheepDog.Cell;
import org.farhan.dsl.sheepdog.sheepDog.Row;
import org.farhan.dsl.sheepdog.sheepDog.SheepDogPackage;
import org.farhan.dsl.sheepdog.sheepDog.TestSuite;
import org.farhan.dsl.sheepdog.sheepDog.TestStep;
import org.farhan.dsl.sheepdog.sheepDog.Table;
import org.farhan.dsl.sheepdog.sheepDog.Text;
import org.farhan.dsl.issues.*;
import org.farhan.dsl.lang.ITestProject;
import org.farhan.dsl.lang.SheepDogFactory;

/**
 * This class contains custom validation rules.
 *
 * See
 * https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#validation
 */
public class SheepDogValidator extends AbstractSheepDogValidator {

	private static final Logger logger = Logger.getLogger(SheepDogValidator.class);
	public static final String CELL_NAME_ONLY = "CELL_NAME_ONLY";
	public static final String TEST_STEP_CONTAINER_NAME_ONLY = "TEST_STEP_CONTAINER_NAME_ONLY";
	public static final String TEST_STEP_CONTAINER_TEST_STEP_FILE_LIST_FILE = "TEST_STEP_CONTAINER_TEST_STEP_FILE_LIST_FILE";
	public static final String TEST_SUITE_NAME_ONLY = "TEST_SUITE_NAME_ONLY";
	public static final String TEST_STEP_STEP_OBJECT_NAME_WORKSPACE = "TEST_STEP_STEP_OBJECT_NAME_WORKSPACE";
	public static final String TEST_STEP_STEP_DEFINITION_NAME_WORKSPACE = "TEST_STEP_STEP_DEFINITION_NAME_WORKSPACE";
	public static final String ROW_CELL_LIST_WORKSPACE = "ROW_CELL_LIST_WORKSPACE";
	public static final String TEST_STEP_STEP_OBJECT_NAME_ONLY = "TEST_STEP_STEP_OBJECT_NAME_ONLY";
	public static final String TEST_STEP_STEP_DEFINITION_NAME_ONLY = "TEST_STEP_STEP_DEFINITION_NAME_ONLY";
	public static final String TEXT_NAME_WORKSPACE = "TEXT_NAME_WORKSPACE";

	@Check(CheckType.FAST)
	public void checkCellNameOnly(Cell cell) {
		initProject(cell.eResource());
		// TODO make tests for this
		if (cell != null) {
			String problems = CellIssueDetector.validateNameOnly(new CellImpl(cell));
			if (!problems.isEmpty()) {
				warning(problems, SheepDogPackage.Literals.CELL__NAME, CELL_NAME_ONLY);
			}
		}
	}

	@Check(CheckType.FAST)
	public void checkRowCellListWorkspace(Row row) {
		try {
			initProject(row.eResource());
			if (row != null && row.eContainer() != null) {
				Table table = (Table) row.eContainer();
				if (table.eContainer() instanceof TestStep) {
					if (!table.getRowList().isEmpty() && table.getRowList().getFirst() == row) {
						String problems = RowIssueDetector.validateCellListWorkspace(new RowImpl(row));
						if (!problems.isEmpty()) {
							warning(problems, SheepDogPackage.Literals.ROW__CELL_LIST, ROW_CELL_LIST_WORKSPACE);
						}
					}
				}
			}
		} catch (Exception e) {
			logError(e, "Row validation");
		}
	}

	@Check(CheckType.FAST)
	public void checkTestStepContainerNameOnly(TestStepContainer theTestStepContainer) {
		try {
			initProject(theTestStepContainer.eResource());
			String problems = TestStepContainerIssueDetector
					.validateNameOnly(new TestStepContainerImpl(theTestStepContainer));
			if (!problems.isEmpty()) {
				warning(problems, SheepDogPackage.Literals.TEST_STEP_CONTAINER__NAME, TEST_STEP_CONTAINER_NAME_ONLY);
			}
		} catch (Exception e) {
			logError(e, theTestStepContainer.getName());
		}
	}

	@Check(CheckType.FAST)
	public void checkTestStepContainerTestStepFileListFile(TestStepContainer theTestStepContainer) {
		try {
			initProject(theTestStepContainer.eResource());
			String problems = TestStepContainerIssueDetector
					.validateTestStepListFile(new TestStepContainerImpl(theTestStepContainer));
			if (!problems.isEmpty()) {
				warning(problems, SheepDogPackage.Literals.TEST_STEP_CONTAINER__TEST_STEP_LIST,
						TEST_STEP_CONTAINER_TEST_STEP_FILE_LIST_FILE);
			}
		} catch (Exception e) {
			logError(e, theTestStepContainer.getName());
		}
	}

	@Check(CheckType.FAST)
	public void checkTestStepNameOnly(TestStep step) {
		TestStepImpl testStep = new TestStepImpl(step);
		try {
			initProject(step.eResource());
			String problems = TestStepIssueDetector.validateStepObjectNameOnly(testStep);
			if (!problems.isEmpty()) {
				error(problems, SheepDogPackage.Literals.TEST_STEP__STEP_OBJECT_NAME,
						TEST_STEP_STEP_OBJECT_NAME_ONLY);
			} else {
				problems = TestStepIssueDetector.validateStepDefinitionNameOnly(testStep);
				if (!problems.isEmpty()) {
					error(problems, SheepDogPackage.Literals.TEST_STEP__STEP_DEFINITION_NAME,
							TEST_STEP_STEP_DEFINITION_NAME_ONLY);
				}
			}
		} catch (Exception e) {
			logError(e, testStep.getName());
		}
	}

	@Check(CheckType.FAST)
	public void checkTestStepNameWorkspace(TestStep step) {
		TestStepImpl testStep = new TestStepImpl(step);
		try {
			initProject(step.eResource());
			String problems = TestStepIssueDetector.validateStepObjectNameWorkspace(testStep);
			if (!problems.isEmpty()) {
				warning(problems, SheepDogPackage.Literals.TEST_STEP__STEP_OBJECT_NAME,
						TEST_STEP_STEP_OBJECT_NAME_WORKSPACE);
			} else {
				problems = TestStepIssueDetector.validateStepDefinitionNameWorkspace(testStep);
				if (!problems.isEmpty()) {
					warning(problems, SheepDogPackage.Literals.TEST_STEP__STEP_DEFINITION_NAME,
							TEST_STEP_STEP_DEFINITION_NAME_WORKSPACE);
				}
			}
		} catch (Exception e) {
			logError(e, testStep.getName());
		}
	}

	@Check(CheckType.FAST)
	public void checkTestSuiteNameOnly(TestSuite theTestSuite) {
		initProject(theTestSuite.eResource());
		// TODO validate that feature file name and feature name are the same.
		TestSuiteImpl testSuiteImpl = new TestSuiteImpl(theTestSuite);
		String problems = TestSuiteIssueDetector.validateNameOnly(testSuiteImpl);
		if (!problems.isEmpty()) {
			warning(problems, SheepDogPackage.Literals.MODEL__NAME, TEST_SUITE_NAME_ONLY);
		}
	}

	@Check(CheckType.FAST)
	public void checkTextNameWorkspace(Text text) {
		initProject(text.eResource());
		if (text != null) {
			String problems = TextIssueDetector.validateNameWorkspace(new TextImpl(text));
			if (!problems.isEmpty()) {
				warning(problems, SheepDogPackage.Literals.TEXT__NAME, TEXT_NAME_WORKSPACE);
			}
		}
	}

	private void logError(Exception e, String name) {
		logger.error("There was a problem for step: " + name);
		StringWriter sw = new StringWriter();
		e.printStackTrace(new PrintWriter(sw));
		logger.error(sw.toString());
	}

	private void initProject(Resource resource) {
		ITestProject parent = SheepDogFactory.instance.createTestProject();
		if (parent.getName() == null) {
			IFile resourceIFile = ResourcesPlugin.getWorkspace().getRoot()
					.getFile(new Path(resource.getURI().toPlatformString(true)));
			File resourceFile = new File(resourceIFile.getProject().getLocationURI());
			parent.setName(resourceFile.getAbsolutePath());
		}
	}
}
