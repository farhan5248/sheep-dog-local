/*
 * generated by Xtext 2.36.0
 */
package org.farhan.dsl.sheepdog.ui.quickfix;

import java.util.ArrayList;

import org.apache.log4j.Logger;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.impl.ResourceSetImpl;
import org.eclipse.jface.text.BadLocationException;
import org.eclipse.xtext.ui.editor.model.edit.IModification;
import org.eclipse.xtext.ui.editor.model.edit.IModificationContext;
import org.eclipse.xtext.ui.editor.quickfix.DefaultQuickfixProvider;
import org.eclipse.xtext.ui.editor.quickfix.Fix;
import org.eclipse.xtext.ui.editor.quickfix.IssueResolutionAcceptor;
import org.eclipse.xtext.validation.Issue;
import org.farhan.dsl.sheepdog.sheepDog.Cell;
import org.farhan.dsl.sheepdog.sheepDog.Row;
import org.farhan.dsl.sheepdog.sheepDog.TestStep;
import org.farhan.dsl.sheepdog.sheepDog.TestStepContainer;
import org.farhan.dsl.sheepdog.sheepDog.TestSuite;
import org.farhan.dsl.sheepdog.sheepDog.Text;
import org.farhan.dsl.issues.CellIssueResolver;
import org.farhan.dsl.issues.RowIssueResolver;
import org.farhan.dsl.issues.SheepDogIssueProposal;
import org.farhan.dsl.issues.TestStepIssueResolver;
import org.farhan.dsl.issues.TestSuiteIssueResolver;
import org.farhan.dsl.issues.TextIssueResolver;
import org.farhan.dsl.issues.TestStepContainerIssueResolver;
import org.farhan.dsl.sheepdog.impl.CellImpl;
import org.farhan.dsl.sheepdog.impl.SourceFileRepository;
import org.farhan.dsl.sheepdog.impl.TestProjectImpl;
import org.farhan.dsl.sheepdog.impl.TestStepContainerImpl;
import org.farhan.dsl.sheepdog.impl.TestStepImpl;
import org.farhan.dsl.sheepdog.impl.TestSuiteImpl;
import org.farhan.dsl.sheepdog.validation.SheepDogValidator;

/**
 * Custom quickfixes.
 *
 * See
 * https://www.eclipse.org/Xtext/documentation/310_eclipse_support.html#quick-fixes
 */
public class SheepDogQuickfixProvider extends DefaultQuickfixProvider {

	private static final Logger logger = Logger.getLogger(SheepDogQuickfixProvider.class);

	private void createAcceptor(Issue issue, IssueResolutionAcceptor acceptor,
			ArrayList<SheepDogIssueProposal> proposals) {
		TestProjectImpl testProject = new TestProjectImpl(
				new SourceFileRepository(getEObject(issue).eResource().getURI().toPlatformString(true)));
		for (SheepDogIssueProposal p : proposals) {
			acceptor.accept(issue, p.getId(), p.getDescription(), "upcase.png", new IModification() {
				public void apply(IModificationContext context) throws BadLocationException {
					if (!p.getQualifiedName().isEmpty()) {
						// TODO use context.getXtextDocument to write to the filesystem instead of
						// TestProject.put
						testProject.addStepObject(p.getQualifiedName(), p.getValue());
					} else {
						context.getXtextDocument().replace(issue.getOffset(), issue.getLength(), p.getValue());
					}
				}
			});
		}
	}

	@Fix(SheepDogValidator.CELL_NAME_ONLY)
	public void fixCellNameOnly(final Issue issue, IssueResolutionAcceptor acceptor) {
		createAcceptor(issue, acceptor, CellIssueResolver.correctNameOnly(new CellImpl((Cell) getEObject(issue))));
	}

	@Fix(SheepDogValidator.ROW_CELL_LIST_WORKSPACE)
	public void fixRowCellListWorkspace(final Issue issue, IssueResolutionAcceptor acceptor) {
		Row theRow = (Row) getEObject(issue);
		createAcceptor(issue, acceptor, RowIssueResolver.correctCellListWorkspace(new TestStepImpl((TestStep) theRow.eContainer().eContainer())));
	}

	@Fix(SheepDogValidator.TEST_STEP_CONTAINER_NAME_ONLY)
	public void fixTestStepContainerNameOnly(final Issue issue, IssueResolutionAcceptor acceptor) {
		createAcceptor(issue, acceptor, TestStepContainerIssueResolver
				.correctNameOnly(new TestStepContainerImpl((TestStepContainer) getEObject(issue))));
	}

	@Fix(SheepDogValidator.TEST_STEP_NAME_OBJECT_WORKSPACE)
	public void fixTestStepNameObjectWorkspace(final Issue issue, IssueResolutionAcceptor acceptor) {
		TestStep step = (TestStep) getEObject(issue);
		createAcceptor(issue, acceptor, TestStepIssueResolver.correctNameObjectWorkspace(new TestStepImpl(step)));
	}

	@Fix(SheepDogValidator.TEST_STEP_NAME_PREDICATE_WORKSPACE)
	public void fixTestStepNamePredicateWorkspace(final Issue issue, IssueResolutionAcceptor acceptor) {
		TestStep step = (TestStep) getEObject(issue);
		createAcceptor(issue, acceptor, TestStepIssueResolver.correctNamePredicateWorkspace(new TestStepImpl(step)));
	}

	@Fix(SheepDogValidator.TEST_SUITE_NAME_ONLY)
	public void fixTestSuiteNameOnly(final Issue issue, IssueResolutionAcceptor acceptor) {
		createAcceptor(issue, acceptor,
				TestSuiteIssueResolver.correctNameOnly(new TestSuiteImpl((TestSuite) getEObject(issue))));
	}

	@Fix(SheepDogValidator.TEXT_NAME_WORKSPACE)
	public void fixTextNameWorkspace(final Issue issue, IssueResolutionAcceptor acceptor) {
		Text theText = (Text) getEObject(issue);
		createAcceptor(issue, acceptor,
				TextIssueResolver.correctNameWorkspace(new TestStepImpl((TestStep) theText.eContainer())));
	}

	private EObject getEObject(Issue issue) {
		Resource resource = new ResourceSetImpl().getResource(issue.getUriToProblem(), true);
		return resource.getEObject(issue.getUriToProblem().toString().split("#")[1]);
	}

}
