/*
 * generated by Xtext 2.36.0
 */
package org.farhan.dsl.sheepdog.ui.quickfix;

import java.io.File;
import java.util.ArrayList;
import org.apache.log4j.Logger;
import org.eclipse.core.resources.IFile;
import org.eclipse.core.resources.ResourcesPlugin;
import org.eclipse.core.runtime.Path;
import org.eclipse.emf.ecore.EObject;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.emf.ecore.resource.impl.ResourceSetImpl;
import org.eclipse.jface.text.BadLocationException;
import org.eclipse.xtext.ui.editor.model.edit.IModification;
import org.eclipse.xtext.ui.editor.model.edit.IModificationContext;
import org.eclipse.xtext.ui.editor.quickfix.DefaultQuickfixProvider;
import org.eclipse.xtext.ui.editor.quickfix.Fix;
import org.eclipse.xtext.ui.editor.quickfix.IssueResolutionAcceptor;
import org.eclipse.xtext.validation.Issue;
import org.farhan.dsl.sheepdog.sheepDog.Cell;
import org.farhan.dsl.sheepdog.sheepDog.Row;
import org.farhan.dsl.sheepdog.sheepDog.TestStep;
import org.farhan.dsl.sheepdog.sheepDog.TestStepContainer;
import org.farhan.dsl.sheepdog.sheepDog.TestSuite;
import org.farhan.dsl.sheepdog.sheepDog.Text;
import org.farhan.dsl.issues.CellIssueResolver;
import org.farhan.dsl.issues.RowIssueResolver;
import org.farhan.dsl.lang.SheepDogIssueProposal;
import org.farhan.dsl.issues.TestStepIssueResolver;
import org.farhan.dsl.issues.TestSuiteIssueResolver;
import org.farhan.dsl.issues.TextIssueResolver;
import org.farhan.dsl.lang.IStepObject;
import org.farhan.dsl.lang.ITestProject;
import org.farhan.dsl.lang.SheepDogBuilder;
import org.farhan.dsl.issues.TestStepContainerIssueResolver;
import org.farhan.dsl.sheepdog.impl.CellImpl;
import org.farhan.dsl.sheepdog.impl.TestStepContainerImpl;
import org.farhan.dsl.sheepdog.impl.TestStepImpl;
import org.farhan.dsl.sheepdog.impl.TestSuiteImpl;
import org.farhan.dsl.sheepdog.validation.SheepDogValidator;

/**
 * Custom quickfixes.
 *
 * See
 * https://www.eclipse.org/Xtext/documentation/310_eclipse_support.html#quick-fixes
 */
public class SheepDogQuickfixProvider extends DefaultQuickfixProvider {
    private static final Logger logger = Logger.getLogger(SheepDogQuickfixProvider.class);

    @Fix(SheepDogValidator.CELL_NAME_ONLY)
    public void fixCellNameOnly(final Issue issue, IssueResolutionAcceptor acceptor) {
        Cell cell = (Cell) getEObject(issue);
        logger.debug("Entering fixCellNameOnly for element: " + (cell != null ? cell.getName() : "null"));
        createAcceptor(issue, acceptor, CellIssueResolver.correctNameOnly(new CellImpl(cell)));
        logger.debug("Exiting fixCellNameOnly");
    }

    @Fix(SheepDogValidator.ROW_CELL_LIST_WORKSPACE)
    public void fixRowCellListWorkspace(final Issue issue, IssueResolutionAcceptor acceptor) {
        Row theRow = (Row) getEObject(issue);
        logger.debug("Entering fixRowCellListWorkspace for element: " + theRow.toString());
        try {
            createAcceptor(issue, acceptor, RowIssueResolver
                    .correctCellListWorkspace(new TestStepImpl((TestStep) theRow.eContainer().eContainer())));
        } catch (Exception e) {
            logger.error("Failed in fixRowCellListWorkspace for: " + e.getMessage(), e);
        }
        logger.debug("Exiting fixRowCellListWorkspace");
    }

    @Fix(SheepDogValidator.TEST_STEP_CONTAINER_NAME_ONLY)
    public void fixTestStepContainerNameOnly(final Issue issue, IssueResolutionAcceptor acceptor) {
        TestStepContainer theTestStepContainer = (TestStepContainer) getEObject(issue);
        logger.debug("Entering fixTestStepContainerNameOnly for element: " + theTestStepContainer.getName());
        createAcceptor(issue, acceptor,
                TestStepContainerIssueResolver.correctNameOnly(new TestStepContainerImpl(theTestStepContainer)));
        logger.debug("Exiting fixTestStepContainerNameOnly");
    }

    @Fix(SheepDogValidator.TEST_STEP_STEP_DEFINITION_NAME_WORKSPACE)
    public void fixTestStepStepDefinitionNameWorkspace(final Issue issue, IssueResolutionAcceptor acceptor) {
        TestStep step = (TestStep) getEObject(issue);
        logger.debug("Entering fixTestStepStepDefinitionNameWorkspace for element: " + step.getStepObjectName());
        try {
            createAcceptor(issue, acceptor,
                    TestStepIssueResolver.correctStepDefinitionNameWorkspace(new TestStepImpl(step)));
        } catch (Exception e) {
            logger.error("Failed fixing step for " + step.getStepObjectName() + ": " + e.getMessage(), e);
        }
        logger.debug("Exiting fixTestStepStepDefinitionNameWorkspace");
    }

    @Fix(SheepDogValidator.TEST_STEP_STEP_OBJECT_NAME_WORKSPACE)
    public void fixTestStepStepObjectNameWorkspace(final Issue issue, IssueResolutionAcceptor acceptor) {
        TestStep step = (TestStep) getEObject(issue);
        logger.debug("Entering fixTestStepStepObjectNameWorkspace for element: " + step.getStepObjectName());
        try {
            createAcceptor(issue, acceptor,
                    TestStepIssueResolver.correctStepObjectNameWorkspace(new TestStepImpl(step)));
        } catch (Exception e) {
            logger.error("Failed fixing step for " + step.getStepObjectName() + ": " + e.getMessage(), e);
        }
        logger.debug("Exiting fixTestStepStepObjectNameWorkspace");
    }

    @Fix(SheepDogValidator.TEST_SUITE_NAME_ONLY)
    public void fixTestSuiteNameOnly(final Issue issue, IssueResolutionAcceptor acceptor) {
        TestSuite theTestSuite = (TestSuite) getEObject(issue);
        logger.debug("Entering fixTestSuiteNameOnly for element: " + theTestSuite.getName());
        createAcceptor(issue, acceptor, TestSuiteIssueResolver.correctNameOnly(new TestSuiteImpl(theTestSuite)));
        logger.debug("Exiting fixTestSuiteNameOnly");
    }

    @Fix(SheepDogValidator.TEXT_NAME_WORKSPACE)
    public void fixTextNameWorkspace(final Issue issue, IssueResolutionAcceptor acceptor) {
        Text theText = (Text) getEObject(issue);
        logger.debug("Entering fixTextNameWorkspace for element: " + theText.getContent());
        try {
            createAcceptor(issue, acceptor,
                    TextIssueResolver.correctNameWorkspace(new TestStepImpl((TestStep) theText.eContainer())));
        } catch (Exception e) {
            logger.error("Failed in fixTextNameWorkspace for: " + e.getMessage(), e);
        }
        logger.debug("Exiting fixTextNameWorkspace");
    }

    private void createAcceptor(Issue issue, IssueResolutionAcceptor acceptor,
            ArrayList<SheepDogIssueProposal> proposals) {
        initProject(getEObject(issue).eResource());
        for (SheepDogIssueProposal p : proposals) {
            acceptor.accept(issue, p.getId(), p.getDescription(), "upcase.png", new IModification() {
                public void apply(IModificationContext context) throws BadLocationException {
                    if (p.getValue() instanceof IStepObject) {
                        try {
                            SheepDogBuilder.createTestProject().addStepObject((IStepObject) p.getValue());
                        } catch (Exception e) {
                            logger.error("Failed writing file for " + p.getValue().toString(), e);
                        }
                    } else {
                        String pipeList = "| " + p.getValue().toString().replaceAll(",", " \\|");
                        context.getXtextDocument().replace(issue.getOffset(), issue.getLength(), pipeList);
                    }
                }
            });
        }
    }

    private EObject getEObject(Issue issue) {
        Resource resource = new ResourceSetImpl().getResource(issue.getUriToProblem(), true);
        return resource.getEObject(issue.getUriToProblem().toString().split("#")[1]);
    }

    private void initProject(Resource resource) {
        ITestProject parent = SheepDogBuilder.createTestProject();
        if (parent.getName() == null) {
            IFile resourceIFile = ResourcesPlugin.getWorkspace().getRoot()
                    .getFile(new Path(resource.getURI().toPlatformString(true)));
            File resourceFile = new File(resourceIFile.getProject().getLocationURI());
            parent.setName(resourceFile.getAbsolutePath());
        }
    }
}
